<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能外贸客户信息收集器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif', 'Microsoft YaHei';
            background-color: #f8fafc;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        th {
            background-color: #f1f5f9;
        }
        .action-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin: 0 4px;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-screen-2xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">智能外贸客户信息收集器</h1>
            <p class="mt-2 text-lg text-slate-500">输入您的产品和目标市场，AI 为您搜集潜在客户信息</p>
        </header>

        <!-- Input Form -->
        <div class="card p-6 md:p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <div>
                    <label for="product" class="block text-sm font-medium text-slate-600 mb-2">您的产品 / 行业</label>
                    <input type="text" id="product" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="例如：太阳能电池板, LED照明, 木制家具">
                </div>
                <div>
                    <label for="market" class="block text-sm font-medium text-slate-600 mb-2">目标国家 / 市场</label>
                    <input type="text" id="market" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="例如：美国, 德国, 东南亚">
                </div>
                <div class="md:col-span-2">
                    <button id="search-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        搜集客户信息
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">潜在客户信息列表</h2>
                <div class="flex space-x-2">
                    <button id="export-csv-btn" class="btn btn-secondary font-semibold py-2 px-4 rounded-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        导出为CSV
                    </button>
                    <button id="clear-results-btn" class="btn btn-secondary font-semibold py-2 px-4 rounded-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        清除结果
                    </button>
                </div>
            </div>
            <div id="loader" class="flex justify-center my-8 hidden">
                <div class="loader"></div>
            </div>
            <div id="error-message" class="hidden text-center text-red-500 mt-4 p-4 bg-red-100 rounded-md"></div>
            <div id="results-table-container" class="w-full overflow-x-auto card">
                <table id="results-table" class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">公司</th>
                            <th scope="col" class="px-6 py-3">公司简介</th>
                            <th scope="col" class="px-6 py-3">公司网站</th>
                            <th scope="col" class="px-6 py-3">联系人</th>
                            <th scope="col" class="px-6 py-3">国家</th>
                            <th scope="col" class="px-6 py-3">联系方式</th>
                            <th scope="col" class="px-6 py-3 text-center">快捷操作</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const searchBtn = document.getElementById('search-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const clearResultsBtn = document.getElementById('clear-results-btn');
        const productInput = document.getElementById('product');
        const marketInput = document.getElementById('market');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const errorMessageDiv = document.getElementById('error-message');
        const resultsTbody = document.getElementById('results-tbody');
        const resultsTableContainer = document.getElementById('results-table-container');

        let foundCompanies = new Set();

        const API_KEY = ""; // This is intentionally left blank; the execution environment handles authentication.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        async function callGeminiAPI(payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        function processApiResult(result) {
            const customersText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (customersText) {
                try {
                    // Clean the text to ensure it's valid JSON
                    const cleanedText = customersText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const customers = JSON.parse(cleanedText);
                    displayResultsInTable(customers);
                } catch (jsonError) {
                    console.error('Error parsing JSON from API:', jsonError, "Received text:", customersText);
                    showError('AI返回的数据格式有误，请尝试调整关键词或稍后重试。');
                }
            } else {
                if (result.promptFeedback) {
                    console.error('Prompt feedback:', result.promptFeedback);
                    showError('您的请求可能因安全原因被阻止，请调整您的输入。');
                } else {
                    showError('未能找到相关客户信息，请尝试更换关键词。');
                }
            }
        }
        
        searchBtn.addEventListener('click', async () => {
            const product = productInput.value.trim();
            const market = marketInput.value.trim();

            if (!product || !market) {
                showError('请输入产品和目标市场。');
                return;
            }

            resultsContainer.style.display = 'block';
            loader.style.display = 'flex';
            hideError();

            const userQuery = `Find 40 potential B2B customers, importers, or distributors for "${product}" in "${market}". For each, find the company name, a concise one-sentence company profile, their official website URL, a relevant contact person (like a purchasing manager), the country, and a contact email or phone number.`;
            const systemPrompt = `You are a B2B market research assistant for foreign trade. Your task is to find potential importing companies. Provide a list of companies. For each company, you must find: 1. The company name. 2. A concise one-sentence company profile. 3. The official company website. 4. A key contact person's name (e.g., Purchasing Manager, Sourcing Manager, Owner). 5. The country. 6. A contact email or phone number. Your response must be ONLY a raw JSON array string. Do not use markdown fences (like \`\`\`json) or any other explanatory text. The response must be a string that can be directly parsed into a JSON array of objects. Each object should have these keys: "company", "profile", "website", "contactPerson", "country", "contactInfo". If a specific piece of information cannot be found, return an empty string for that field. Prioritize finding the official website and company profile. Avoid duplicate companies.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiAPI(payload);
                processApiResult(result);
            } catch (apiError) {
                console.error('Error calling Gemini API:', apiError);
                showError('调用AI服务时发生网络错误，请稍后重试。');
            } finally {
                loader.style.display = 'none';
            }
        });

        function displayResultsInTable(customers) {
            if (!customers || customers.length === 0) {
                 showError('本次未能找到更多客户信息，请尝试更换关键词。');
                return;
            }
            
            let newCustomersFound = 0;
            customers.forEach(customer => {
                const companyName = (customer.company || '').trim();
                
                if (companyName && !foundCompanies.has(companyName.toLowerCase())) {
                    foundCompanies.add(companyName.toLowerCase());
                    newCustomersFound++;

                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';

                    let website = customer.website || '';
                    if (website && !website.startsWith('http')) {
                        website = 'https://' + website;
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${companyName}</td>
                        <td class="px-6 py-4 text-slate-600">${customer.profile || ''}</td>
                        <td class="px-6 py-4"><a href="${website}" target="_blank" class="text-blue-600 hover:underline">${customer.website || ''}</a></td>
                        <td class="px-6 py-4">${customer.contactPerson || ''}</td>
                        <td class="px-6 py-4">${customer.country || ''}</td>
                        <td class="px-6 py-4">${customer.contactInfo || ''}</td>
                        <td class="px-6 py-4 text-center">
                            <a href="https://www.google.com/search?q=${encodeURIComponent(companyName)}" target="_blank" class="action-link bg-slate-200 hover:bg-slate-300" title="Google 搜索">
                                <svg class="w-4 h-4 text-slate-600" fill="currentColor" viewBox="0 0 24 24"><path d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.75 8.36,4.73 12.19,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.2 6.42,22 12.19,22C17.6,22 21.54,18.33 21.54,12.81C21.54,11.9,21.35,11.1,21.35,11.1V11.1Z"/></svg>
                            </a>
                            <a href="https://www.linkedin.com/search/results/companies/?keywords=${encodeURIComponent(companyName)}" target="_blank" class="action-link bg-blue-100 hover:bg-blue-200" title="LinkedIn 搜索">
                                <svg class="w-4 h-4 text-blue-700" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                            </a>
                        </td>
                    `;
                    resultsTbody.appendChild(row);
                }
            });

            if (newCustomersFound === 0 && customers.length > 0) {
                showError('本次搜索未发现新的客户信息。');
            }

            resultsTableContainer.style.display = 'block';
        }

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
        }

        function hideError() {
            errorMessageDiv.style.display = 'none';
        }

        function exportTableToCSV(filename) {
            const csv = [];
            const rows = document.querySelectorAll("#results-table tr");
            
            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const rowData = [];
                for (const col of cols) {
                    let data = col.innerText.replace(/"/g, '""'); 
                    rowData.push(`"${data}"`);
                }
                csv.push(rowData.join(","));
            }

            const csvFile = new Blob([`\uFEFF${csv.join("\n")}`], { type: "text/csv;charset=utf-8;" });
            const downloadLink = document.createElement("a");
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        exportCsvBtn.addEventListener('click', () => {
             const product = productInput.value.trim().replace(/\s+/g, '_') || "产品";
             const market = marketInput.value.trim().replace(/\s+/g, '_') || "市场";
             const date = new Date().toISOString().slice(0, 10);
             exportTableToCSV(`客户线索_${product}_${market}_${date}.csv`);
        });

        clearResultsBtn.addEventListener('click', () => {
            resultsContainer.style.display = 'none';
            resultsTbody.innerHTML = '';
            productInput.value = '';
            marketInput.value = '';
            hideError();
            foundCompanies.clear();
        });

    </script>
</body>
</html>

